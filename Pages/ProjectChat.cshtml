@page
@model frontAIagent.Pages.ProjectChatModel
@{
    ViewData["Title"] = Model.Project.AnalysisName + " - AI Analysis";
}

<div class="container-fluid px-4 py-4">
    <div class="row g-4">
        <!-- Левая панель - информация о проекте -->
        <div class="col-xl-4 col-lg-5">
            <!-- Карточка проекта -->
            <div class="card project-card border-0 shadow-lg">
                <div class="card-header bg-gradient-primary text-white py-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-folder2-open fs-4 me-3"></i>
                        <div>
                            <h4 class="mb-0 fw-bold">Project Overview</h4>
                            <small class="opacity-75">@Model.Project.AnalysisName</small>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="project-info-grid">
                        <div class="info-item">
                            <div class="info-icon bg-primary bg-opacity-10 text-primary">
                                <i class="bi bi-folder"></i>
                            </div>
                            <div class="info-content">
                                <label class="info-label">Directory</label>
                                <p class="info-value text-truncate" title="@Model.Project.DirectoryPath">@Model.Project.DirectoryPath</p>
                            </div>
                        </div>

                        <div class="info-item">
                            <div class="info-icon bg-info bg-opacity-10 text-info">
                                <i class="bi bi-filetype-@(Model.Project.FileType.Replace(".", ""))"></i>
                            </div>
                            <div class="info-content">
                                <label class="info-label">File Type</label>
                                <div class="info-value">
                                    <span class="tech-badge @GetFileTypeBadgeClass(Model.Project.FileType)">
                                        @Model.Project.FileType
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="info-item">
                            <div class="info-icon bg-warning bg-opacity-10 text-warning">
                                <i class="bi bi-clock-history"></i>
                            </div>
                            <div class="info-content">
                                <label class="info-label">Last Analyzed</label>
                                <p class="info-value">@Model.Project.LastAnalyzed.ToString("MMM dd, yyyy HH:mm")</p>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(Model.Project.LogPath))
                        {
                            <div class="info-item">
                                <div class="info-icon bg-success bg-opacity-10 text-success">
                                    <i class="bi bi-journal-text"></i>
                                </div>
                                <div class="info-content">
                                    <label class="info-label">Logs Directory</label>
                                    <p class="info-value text-truncate">@Model.Project.LogPath</p>
                                </div>
                            </div>
                        }

                        <div class="info-item full-width">
                            <div class="info-icon bg-secondary bg-opacity-10 text-secondary">
                                <i class="bi bi-card-text"></i>
                            </div>
                            <div class="info-content">
                                <label class="info-label">Description</label>
                                <p class="info-value description-text">@Model.Project.ProgramDescription</p>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid mt-4">
                        <a href="/" class="btn btn-outline-primary btn-hover">
                            <i class="bi bi-arrow-left me-2"></i>Back to Projects
                        </a>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card border-0 shadow-lg mt-4">
                <div class="card-header bg-light py-3">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="bi bi-lightning-charge-fill text-warning me-2"></i>
                        Quick Analysis
                    </h5>
                </div>
                <div class="card-body p-3">
                    <div class="quick-actions-grid">
                        <button type="button" class="quick-action-btn" onclick="quickPrompt('Analyze code quality and suggest improvements')">
                            <div class="action-icon bg-primary bg-opacity-10 text-primary">
                                <i class="bi bi-graph-up"></i>
                            </div>
                            <span>Code Quality</span>
                        </button>

                        <button type="button" class="quick-action-btn" onclick="quickPrompt('Check for security vulnerabilities and best practices')">
                            <div class="action-icon bg-success bg-opacity-10 text-success">
                                <i class="bi bi-shield-check"></i>
                            </div>
                            <span>Security Scan</span>
                        </button>

                        <button type="button" class="quick-action-btn" onclick="quickPrompt('Optimize performance and identify bottlenecks')">
                            <div class="action-icon bg-warning bg-opacity-10 text-warning">
                                <i class="bi bi-speedometer2"></i>
                            </div>
                            <span>Performance</span>
                        </button>

                        <button type="button" class="quick-action-btn" onclick="quickPrompt('Review architecture and design patterns')">
                            <div class="action-icon bg-info bg-opacity-10 text-info">
                                <i class="bi bi-diagram-3"></i>
                            </div>
                            <span>Architecture</span>
                        </button>

                        <!-- Documentation button as POST -->
                        <form method="post" asp-page-handler="AskGptDocumentation" class="quick-action-btn p-0 m-0 border-0 bg-transparent">
                            <button type="submit" class="quick-action-btn w-100">
                                <div class="action-icon bg-secondary bg-opacity-10 text-secondary">
                                    <i class="bi bi-book"></i>
                                </div>
                                <span>Documentation</span>
                            </button>
                        </form>
                    </div>

                    </div>
                </div>
            </div>

            <!-- File Statistics -->
            @if (Model.FileContext != null)
            {
                <div class="card border-0 shadow-lg mt-4">
                    <div class="card-header bg-gradient-info text-white py-3">
                        <h5 class="mb-0 d-flex align-items-center">
                            <i class="bi bi-pie-chart-fill me-2"></i>
                            File Statistics
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="stats-grid">
                            <div class="stat-item success">
                                <div class="stat-value">@Model.FileContext.SuccessFiles</div>
                                <div class="stat-label">Successful</div>
                                <div class="stat-icon">
                                    <i class="bi bi-check-circle-fill"></i>
                                </div>
                            </div>

                            <div class="stat-item total">
                                <div class="stat-value">@Model.FileContext.TotalFiles</div>
                                <div class="stat-label">Total Files</div>
                                <div class="stat-icon">
                                    <i class="bi bi-files"></i>
                                </div>
                            </div>

                            @if (Model.FileContext.FailedFiles > 0)
                            {
                                <div class="stat-item danger">
                                    <div class="stat-value">@Model.FileContext.FailedFiles</div>
                                    <div class="stat-label">Failed</div>
                                    <div class="stat-icon">
                                        <i class="bi bi-exclamation-circle-fill"></i>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Основной контент -->
        <div class="col-xl-8 col-lg-7">
            <!-- AI Chat Assistant -->
            <div class="card border-0 shadow-lg h-100">
                <div class="card-header bg-gradient-success text-white py-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-robot fs-4 me-3"></i>
                            <div>
                                <h4 class="mb-0 fw-bold">AI Analysis Assistant</h4>
                                <small class="opacity-75">Powered by GPT-4</small>
                            </div>
                        </div>
                        <div class="typing-indicator d-none">
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                            <small class="ms-2">AI is thinking...</small>
                        </div>
                    </div>
                </div>

                <div class="card-body d-flex flex-column p-0">
                    <!-- История чата -->
                    <div id="chatHistory" class="chat-messages flex-grow-1 p-4">
                        @if (Model.ChatMessages.Any())
                        {
                            @foreach (var message in Model.ChatMessages)
                            {
                                <div class="message @(message.IsUser ? "user-message" : "ai-message")">
                                    <div class="message-avatar">
                                        @if (message.IsUser)
                                        {
                                            <div class="avatar bg-primary">
                                                <i class="bi bi-person-fill"></i>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="avatar bg-success">
                                                <i class="bi bi-robot"></i>
                                            </div>
                                        }
                                    </div>
                                    <div class="message-content">
                                        <div class="message-header">
                                            <strong>@(message.IsUser ? "You" : "AI Assistant")</strong>
                                            <small class="text-muted">@message.Timestamp.ToString("HH:mm")</small>
                                        </div>
                                        <div class="message-text">@message.Content</div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="empty-chat-state text-center py-5">
                                <div class="empty-icon mb-3">
                                    <i class="bi bi-chat-left-dots-fill text-muted" style="font-size: 3rem;"></i>
                                </div>
                                <h5 class="text-muted mb-2">Start a Conversation</h5>
                                <p class="text-muted mb-4">Ask AI to analyze your project code, architecture, or suggest improvements</p>
                                <div class="suggestions">
                                    <button type="button" class="btn btn-outline-primary btn-sm me-2 mb-2" onclick="quickPrompt('What does this project do?')">
                                        What does this project do?
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm me-2 mb-2" onclick="quickPrompt('Review the code structure')">
                                        Review code structure
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm mb-2" onclick="quickPrompt('Suggest improvements')">
                                        Suggest improvements
                                    </button>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Форма ввода -->
                    <div class="chat-input-container p-4 border-top">
                        <form method="post" asp-page-handler="AskGpt" id="chatForm">
                            <input type="hidden" name="projectId" value="@Model.Project.Id" />
                            <div class="input-group input-group-lg">
                                <textarea class="form-control chat-input" name="userMessage" id="userMessage"
                                          rows="2" placeholder="Ask AI about your project..." required>@Model.UserMessage</textarea>
                                <button type="submit" class="btn btn-success btn-send" id="sendButton">
                                    <i class="bi bi-send-fill"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Analysis Results -->
            @if (!string.IsNullOrEmpty(Model.AnalysisResult))
            {
                <div class="card border-0 shadow-lg mt-4">
                    <div class="card-header bg-gradient-info text-white py-3">
                        <h5 class="mb-0 d-flex align-items-center">
                            <i class="bi bi-file-earmark-text-fill me-2"></i>
                            Analysis Results
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="analysis-result">
                            @Html.Raw(ConvertMarkdownToHtml(Model.AnalysisResult))
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@functions {
    private string GetFileTypeBadgeClass(string fileType)
    {
        return fileType.ToLower() switch
        {
            ".py" => "python-badge",
            ".cs" => "csharp-badge", 
            ".js" => "javascript-badge",
            ".ts" => "typescript-badge",
            ".java" => "java-badge",
            _ => "default-badge"
        };
    }

    private string ConvertMarkdownToHtml(string markdown)
    {
        if (string.IsNullOrEmpty(markdown))
            return string.Empty;

        // Простая конвертация Markdown в HTML
        var html = markdown
            .Replace("### ", "<h3>").Replace("\n###", "</h3>\n")
            .Replace("## ", "<h2>").Replace("\n##", "</h2>\n") 
            .Replace("# ", "<h1>").Replace("\n#", "</h1>\n")
            .Replace("**", "<strong>").Replace("**", "</strong>")
            .Replace("*", "<em>").Replace("*", "</em>")
            .Replace("`", "<code>").Replace("`", "</code>")
            .Replace("```", "<pre><code>").Replace("```", "</code></pre>")
            .Replace("- ", "<li>").Replace("\n- ", "</li>\n<li>")
            .Replace("\n", "<br/>");

        if (html.Contains("<li>"))
        {
            html = html.Replace("<li>", "<ul><li>").Replace("</li>", "</li></ul>");
        }

        return html;
    }
}

@section Scripts {
    <script>
                function submitDocumentation(projectId) {
            const form = document.createElement('form');
            form.method = 'post';
            form.action = '?handler=AskGptDocumentation';

            const projectIdInput = document.createElement('input');
            projectIdInput.type = 'hidden';
            projectIdInput.name = 'projectId';
            projectIdInput.value = projectId;

            const messageInput = document.createElement('input');
            messageInput.type = 'hidden';
            messageInput.name = 'userMessage';
            messageInput.value = 'Generate complete project documentation including classes, methods, project structure, usage instructions, and examples';

            form.appendChild(projectIdInput);
            form.appendChild(messageInput);
            document.body.appendChild(form);

            form.submit();
        }       
        function quickPrompt(promptText) {
            document.getElementById('userMessage').value = promptText;
            document.getElementById('userMessage').focus();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const chatHistory = document.getElementById('chatHistory');
            const chatForm = document.getElementById('chatForm');
            const sendButton = document.getElementById('sendButton');
            const userMessage = document.getElementById('userMessage');
            const typingIndicator = document.querySelector('.typing-indicator');

            // Автофокус и прокрутка
            userMessage.focus();
            chatHistory.scrollTop = chatHistory.scrollHeight;

            // Обработка отправки формы
            chatForm.addEventListener('submit', function(e) {
                const originalHTML = sendButton.innerHTML;
                
                // Показываем индикатор загрузки
                sendButton.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                sendButton.disabled = true;
                typingIndicator.classList.remove('d-none');

                // Восстанавливаем кнопку через 30 секунд (на всякий случай)
                setTimeout(() => {
                    sendButton.innerHTML = originalHTML;
                    sendButton.disabled = false;
                    typingIndicator.classList.add('d-none');
                }, 30000);
            });

            // Авто-высота textarea
            userMessage.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        });
    </script>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --info-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
            --border-radius: 16px;
        }

        .project-card, .card {
            border-radius: var(--border-radius);
            border: none;
        }

        .card-header.bg-gradient-primary {
            background: var(--primary-gradient) !important;
        }

        .card-header.bg-gradient-success {
            background: var(--success-gradient) !important;
        }

        .card-header.bg-gradient-info {
            background: var(--info-gradient) !important;
        }

        /* Project Info Grid */
        .project-info-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .info-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .info-item:hover {
            background: rgba(0,0,0,0.02);
        }

        .info-item.full-width {
            grid-column: 1 / -1;
        }

        .info-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.25rem;
        }

        .info-content {
            flex: 1;
            min-width: 0;
        }

        .info-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }

        .info-value {
            font-size: 0.95rem;
            color: #2c3e50;
            margin: 0;
            line-height: 1.4;
        }

        .description-text {
            line-height: 1.5;
        }

        /* Tech Badges */
        .tech-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .python-badge { background: linear-gradient(135deg, #3776ab, #ffde57); color: #000; }
        .csharp-badge { background: linear-gradient(135deg, #239}
}